@page "/cook/calendar"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "cook,admin")]

@using CSE325_visioncoders.Models
@using CSE325_visioncoders.Services
@inject CalendarService CalendarService
@inject MealService MealService
@inject NavigationManager Nav

@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider AuthStateProvider
@inject MenuDayService MenuDayService

<div class="titleBar">
    <img class="titleIcon" src="img/calendarIcon.svg" alt="calendar icon">
    <a>Calendar</a>
</div>


<!-- ALERTS -->
@if (!string.IsNullOrEmpty(todayAlert) || !string.IsNullOrEmpty(tomorrowAlert))
{
    <div class="mb-3">
        @if (!string.IsNullOrEmpty(todayAlert))
        {
            <div class="alert alert-info" style="margin-top: 1rem;">
                @todayAlert
            </div>
        }

        @if (!string.IsNullOrEmpty(tomorrowAlert))
        {
            <div class="alert alert-secondary">
                @tomorrowAlert
            </div>
        }
    </div>
}

<!-- HEADER -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="m-0">Weekly Calendar</h3>

    <button class="btn btn-outline-secondary" @onclick="GoToMonthView">
        ðŸ“… View Full Month
    </button>
</div>

<!-- WEEK NAVIGATION -->
<div class="d-flex align-items-center mb-3">
    <button class="btn btn-outline-primary me-2" @onclick="PreviousWeek">â—€ Previous</button>
    <h4 class="m-0">@weekStart.ToString("dd MMM yyyy") - @weekEnd.ToString("dd MMM yyyy")</h4>
    <button class="btn btn-outline-primary ms-2" @onclick="NextWeek">Next â–¶</button>
</div>

<!-- WEEK GRID -->
<table class="table table-bordered calendar-table-sm">
    <thead>
        <tr>
            @foreach (var dayName in dayNames)
            {
                <th class="text-center">@dayName</th>
            }
        </tr>
    </thead>

    <tbody>
        <tr>
            @for (int i = 0; i < 7; i++)
            {
                var day = weekStart.AddDays(i);
                menuByDate.TryGetValue(day.Date, out var menu);
                var eventsOfDay = CalendarService.GetEventsByDay(day.Date).ToList();

                <td class="calendar-cell-sm @(selectedDate.Date == day.Date ? "calendar-cell-selected" : "")"
                    @onclick="() => SelectDay(day)">

                    <!-- DATE + STATUS -->
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>@day.Day</strong>

                        @if (menu != null)
                        {
                            <span class="badge bg-@GetStatusColor(menu.Status)">
                                @menu.Status
                            </span>
                        }
                    </div>

                    <!-- DISHES -->
                    @if (menu != null)
                    {
                        @foreach (var dish in menu.Dishes.OrderBy(d => d.Index))
                        {
                            if (!string.IsNullOrWhiteSpace(dish.Name))
                            {
                                <div class="small text-truncate">â€¢ @dish.Name</div>
                            }
                        }
                    }

                    <!-- EVENT ICONS -->
                    @if (eventsOfDay.Any())
                    {
                        <div class="mt-1 small">
                            @foreach (var ev in eventsOfDay.Take(3))
                            {
                                <span title="@($"{ev.Title} ({ev.Start:HH:mm})")">
                                    @GetEventIcon(ev.Category)
                                </span>
                            }
                            @if (eventsOfDay.Count > 3)
                            {
                                <span>+@((eventsOfDay.Count - 3))</span>
                            }
                        </div>
                    }
                </td>
            }
        </tr>
    </tbody>
</table>

<!-- SIDE PANEL -->
@if (selectedMenuDay != null)
{
    bool isClosed = isDayClosed;

    <div class="card mt-4">
        <div class="card-header">
            @selectedMenuDay.Date.ToString("dddd dd MMMM")
        </div>

        <div class="card-body">

            <!-- STATUS -->
            <div class="mb-3">
                <label class="form-label">Status</label>
                <select class="form-select" @bind="selectedMenuDay.Status" disabled="@isClosed">
                    <option value="@MenuDayStatus.Draft">Draft</option>
                    <option value="@MenuDayStatus.Published">Published</option>
                    <option value="@MenuDayStatus.Closed">Closed</option>
                </select>
            </div>

            <!-- DISHES SELECT -->
            @foreach (var dish in selectedMenuDay.Dishes.OrderBy(d => d.Index))
            {
                <div class="mb-3 border rounded p-2">
                    <h6>Dish @dish.Index</h6>

                    <div class="mb-2">
                        <label class="form-label">Meal</label>

                        <select class="form-select" value="@dish.MealId"
                            @onchange="(ChangeEventArgs e) => OnMealSelected(dish, e.Value?.ToString())" disabled="@isClosed">

                            <option value="">-- Select meal --</option>

                            @foreach (var m in meals)
                            {
                                <option value="@m.Id" selected="@((dish.MealId == m.Id))">
                                    @m.Name (@m.Price.ToString("0.00"))
                                </option>
                            }
                        </select>
                    </div>

                    @if (!string.IsNullOrWhiteSpace(dish.Name))
                    {
                        <div class="mb-2 small text-muted">
                            Selected: <strong>@dish.Name</strong>
                        </div>
                    }

                    <div>
                        <label class="form-label">Notes</label>
                        <input class="form-control" @bind="dish.Notes" disabled="@isClosed" />
                    </div>
                </div>
            }

            <button class="btn btn-primary mt-3" @onclick="SaveMenu" disabled="@isClosed">
                Save Menu
            </button>

            <button class="btn btn-outline-info mt-3 ms-2" @onclick="() => GoToDayView(selectedMenuDay.Date)">
                View Full Day â†’
            </button>
        </div>
    </div>
}

@code {
    private DateTime weekStart;
    private DateTime weekEnd;
    private DateTime selectedDate;

    private readonly Dictionary<DateTime, MenuDay> menuByDate = new();
    private MenuDay? selectedMenuDay;

    private List<Meal> meals = new();

    private bool isDayClosed = false;

    private string? todayAlert;
    private string? tomorrowAlert;

    private string? CookId;
    private string TimeZoneId = "America/Bogota";

    private readonly string[] dayNames = { "Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun" };

    private void LoadWeek()
    {
        menuByDate.Clear();

        var menus = CalendarService.GetMenuForRange(weekStart, weekEnd);
        foreach (var m in menus)
            menuByDate[m.Date.Date] = m;

        for (int i = 0; i < 7; i++)
        {
            var d = weekStart.AddDays(i).Date;

            if (!menuByDate.ContainsKey(d))
                menuByDate[d] = CalendarService.GetOrCreateMenuDay(d);
        }
    }

    private void PreviousWeek()
    {
        weekStart = weekStart.AddDays(-7);
        weekEnd = weekStart.AddDays(6);
        LoadWeek();
        SelectDay(weekStart);
        UpdateAlerts();
    }

    private void NextWeek()
    {
        weekStart = weekStart.AddDays(7);
        weekEnd = weekStart.AddDays(6);
        LoadWeek();
        SelectDay(weekStart);
        UpdateAlerts();
    }

    private void SelectDay(DateTime day)
    {
        selectedDate = day.Date;
        selectedMenuDay = CalendarService.GetOrCreateMenuDay(selectedDate);
        isDayClosed = CalendarService.IsDayClosed(selectedDate);
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadAuthAsync(); // â† nuevo

        meals = await MealService.GetAsync();

        var today = DateTime.Today;
        weekStart = StartOfWeek(today);
        weekEnd = weekStart.AddDays(6);

        LoadWeek();
        SelectDay(today);
        UpdateAlerts();
    }

    private async void SaveMenu()
    {
        if (selectedMenuDay == null || isDayClosed) return;
        if (string.IsNullOrWhiteSpace(CookId)) return;

        await MenuDayService.UpsertMenuDayAsync(selectedMenuDay, CookId!, TimeZoneId);

        CalendarService.SaveMenuDay(selectedMenuDay);
        LoadWeek();
        SelectDay(selectedMenuDay.Date);
        UpdateAlerts();
        StateHasChanged();
    }

    private void OnMealSelected(MenuDish dish, string? mealId)
    {
        if (isDayClosed) return;

        dish.MealId = mealId ?? string.Empty;

        if (string.IsNullOrWhiteSpace(dish.MealId))
        {
            dish.Name = string.Empty;
            return;
        }

        var meal = meals.FirstOrDefault(m => m.Id == dish.MealId);
        if (meal != null)
        {
            dish.Name = meal.Name;

            if (string.IsNullOrWhiteSpace(dish.Notes))
                dish.Notes = meal.Description;
        }
    }

    private void GoToMonthView() =>
    Nav.NavigateTo("/cook/calendar/month");

    private void GoToDayView(DateTime date) =>
    Nav.NavigateTo($"/cook/calendar/day/{date:yyyy-MM-dd}");

    private static DateTime StartOfWeek(DateTime date)
    {
        int diff = (7 + (date.DayOfWeek - DayOfWeek.Monday)) % 7;
        return date.AddDays(-diff).Date;
    }

    private string GetStatusColor(MenuDayStatus status) =>
    status switch
    {
        MenuDayStatus.Draft => "secondary",
        MenuDayStatus.Published => "success",
        MenuDayStatus.Closed => "dark",
        _ => "secondary"
    };

    private string GetEventIcon(CalendarEventCategory cat)
    {
        return cat switch
        {
            CalendarEventCategory.Purchase => "ðŸ›’",
            CalendarEventCategory.Delivery => "ðŸ“¦",
            CalendarEventCategory.Shift => "ðŸ‘¨â€ðŸ³",
            CalendarEventCategory.Maintenance => "ðŸ› ï¸",
            CalendarEventCategory.Admin => "ðŸ“‹",
            CalendarEventCategory.Meeting => "ðŸ—“ï¸",
            _ => "ðŸ”¹"
        };
    }

    private void UpdateAlerts()
    {
        todayAlert = null;
        tomorrowAlert = null;

        var today = DateTime.Today;
        var tomorrow = today.AddDays(1);

        bool todayClosed = CalendarService.IsDayClosed(today);
        bool tomorrowClosed = CalendarService.IsDayClosed(tomorrow);

        todayAlert = todayClosed
        ? $"Today ({today:dd MMM}) is CLOSED (cutoff 08:00)."
        : $"Today ({today:dd MMM}) is OPEN until 08:00.";

        tomorrowAlert = tomorrowClosed
        ? $"Tomorrow ({tomorrow:dd MMM}) is CLOSED."
        : $"Tomorrow ({tomorrow:dd MMM}) cutoff 08:00.";
    }

    private static string? GetClaim(ClaimsPrincipal user, string type)
    => user?.Claims?.FirstOrDefault(c => c.Type == type)?.Value;

    private async Task LoadAuthAsync()
    {
        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = state.User;

        CookId = GetClaim(user, ClaimTypes.NameIdentifier)
        ?? GetClaim(user, "sub")
        ?? GetClaim(user, "oid")
        ?? GetClaim(user, "id");
    }
}

<style>
    .calendar-table-sm {
        width: 100%;
        background-color: #ffffff;
    }

    .calendar-cell-sm {
        height: 80px;
        cursor: pointer;
        padding: 4px;
        vertical-align: top;
        font-size: 14px;
    }

    .calendar-cell-sm:hover {
        background-color: #eef6ff;
    }

    .calendar-cell-selected {
        outline: 2px solid #0d6efd;
        background-color: #e7f1ff;
    }
</style>