@page "/cook/inventory"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "cook,admin")]
@layout MainLayout
@rendermode InteractiveServer

@using System.Linq
@using System.Security.Claims
@using CSE325_visioncoders.Models
@using CSE325_visioncoders.Services
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Authorization

@inject InventoryService InventoryService
@inject AuthService Auth

<div class="titleBar">
    <img class="titleIcon" src="img/inventoryIcon.svg" alt="inventory icon">
    <a>Inventory</a>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

@if (isLoading)
{
    <p>Loading inventory...</p>
}
else
{
    <div class="inventory-page">
        <div class="inventory-header">
            <button class="btn btn-primary" type="button" @onclick="StartAdd">
                + Add Ingredient
            </button>
        </div>

        @if (items is null || items.Count == 0)
        {
            <p>No ingredients in your inventory yet.</p>
        }
        else
        {
            <table class="table table-sm table-striped align-middle">
                <thead>
                    <tr>
                        <th>Ingredient</th>
                        <th>Quantity</th>
                        <th>Low Stock At</th>
                        <th>Status</th>
                        <th>Last Updated</th>
                        <th style="width: 230px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in items)
                    {
                        var status = GetStatus(item);
                        var rowClass = status == "Low" ? "table-warning" : "";

                        <tr class="@rowClass">
                            <td>@item.Name</td>
                            <td>@item.Quantity @item.Unit</td>
                            <td>
                                @if (item.LowStockThreshold.HasValue)
                                {
                                    @($"{item.LowStockThreshold.Value} {item.Unit}")
                                }
                                else
                                {
                                    <span>-</span>
                                }
                            </td>
                            <td>@status</td>
                            <td>@item.LastUpdated.ToLocalTime().ToString("g")</td>
                            <td>
                                <div class="btn-group me-2" role="group" aria-label="Quantity controls">
                                    <button class="btn btn-sm btn-outline-secondary"
                                            type="button"
                                            title="Decrease by 1"
                                            @onclick="() => ChangeQuantity(item, -1)">
                                        -1
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary"
                                            type="button"
                                            title="Increase by 1"
                                            @onclick="() => ChangeQuantity(item, 1)">
                                        +1
                                    </button>
                                </div>

                                <div class="btn-group" role="group" aria-label="Edit and delete">
                                    <button class="btn btn-sm btn-outline-primary"
                                            type="button"
                                            @onclick="() => StartEdit(item)">
                                        Edit
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger"
                                            type="button"
                                            @onclick="() => DeleteItem(item.Id!)">
                                        Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }

        @if (showForm)
        {
            <div class="inventory-form card mt-3 p-3">
                <h5>@(isEditMode ? "Edit Ingredient" : "Add Ingredient")</h5>

                <EditForm Model="@formItem" OnValidSubmit="@SaveItem">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="mb-2">
                        <label class="form-label">Name</label>
                        <InputText class="form-control" @bind-Value="formItem.Name" />
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Quantity</label>
                        <InputNumber class="form-control" TValue="decimal" @bind-Value="formItem.Quantity" />
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Unit</label>
                        <InputText class="form-control" @bind-Value="formItem.Unit" placeholder="pcs, kg, g, packs..." />
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Low Stock Threshold (optional)</label>
                        <InputNumber class="form-control" TValue="decimal?" @bind-Value="formItem.LowStockThreshold" />
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Notes (optional)</label>
                        <InputTextArea class="form-control" @bind-Value="formItem.Notes" />
                    </div>

                    <div class="mt-3">
                        <button class="btn btn-primary" type="submit" disabled="@isSaving">
                            @(isEditMode ? "Save Changes" : "Add Ingredient")
                        </button>
                        <button class="btn btn-secondary ms-2" type="button" @onclick="CancelForm">
                            Cancel
                        </button>
                    </div>
                </EditForm>
            </div>
        }
    </div>
}

@code {
    private List<InventoryItem>? items;
    private bool isLoading = true;
    private bool isSaving = false;

    private bool showForm = false;
    private bool isEditMode = false;
    private InventoryItem formItem = new();

    private string? currentCookId;
    private string? errorMessage;

    // Get auth state for current user
    [CascadingParameter]
    private Task<AuthenticationState> AuthStateTask { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        errorMessage = null;

        currentCookId = await EnsureCookIdAsync();

        if (string.IsNullOrEmpty(currentCookId))
        {
            items = new List<InventoryItem>();
            isLoading = false;
            errorMessage = "No cook id found for current user.";
            return;
        }

        items = await InventoryService.GetByCookAsync(currentCookId);
        isLoading = false;
    }

    private async Task<string?> EnsureCookIdAsync()
    {
        if (!string.IsNullOrWhiteSpace(currentCookId))
            return currentCookId;

        // get current user id from auth state
        var authState = await AuthStateTask;
        var user = authState.User;

        currentCookId =
            user.FindFirst(ClaimTypes.NameIdentifier)?.Value
            ?? user.FindFirst("sub")?.Value
            ?? user.FindFirst("id")?.Value
            ?? Auth.UserId;

        return currentCookId;
    }

    private async Task ReloadAsync()
    {
        var cookId = await EnsureCookIdAsync();
        if (string.IsNullOrEmpty(cookId))
            return;

        items = await InventoryService.GetByCookAsync(cookId);
        StateHasChanged();
    }

    private void StartAdd()
    {
        isEditMode = false;
        errorMessage = null;

        formItem = new InventoryItem
        {
            Quantity = 0,
            Unit = "pcs"
        };
        showForm = true;
    }

    private void StartEdit(InventoryItem item)
    {
        isEditMode = true;
        errorMessage = null;

        formItem = new InventoryItem
        {
            Id = item.Id,
            CookId = item.CookId,
            Name = item.Name,
            Quantity = item.Quantity,
            Unit = item.Unit,
            LowStockThreshold = item.LowStockThreshold,
            Notes = item.Notes
        };
        showForm = true;
    }

    private async Task SaveItem()
    {
        errorMessage = null;

        if (string.IsNullOrWhiteSpace(formItem.Name))
        {
            errorMessage = "Name is required.";
            return;
        }

        var cookId = await EnsureCookIdAsync();

        if (string.IsNullOrWhiteSpace(cookId))
        {
            errorMessage = "Cannot save: cook id is missing.";
            return;
        }

        try
        {
            isSaving = true;

            if (string.IsNullOrWhiteSpace(formItem.Unit))
                formItem.Unit = "pcs";

            formItem.CookId = cookId;
            formItem.LastUpdated = DateTime.UtcNow;

            if (isEditMode)
            {
                await InventoryService.UpdateAsync(cookId, formItem);
            }
            else
            {
                await InventoryService.CreateAsync(formItem);
            }

            isSaving = false;
            showForm = false;

            await ReloadAsync();
        }
        catch (Exception ex)
        {
            isSaving = false;
            errorMessage = $"Error saving ingredient: {ex.Message}";
            Console.WriteLine(ex);
        }
    }

    private void CancelForm()
    {
        showForm = false;
        isEditMode = false;
        formItem = new InventoryItem();
        errorMessage = null;
    }

    private async Task DeleteItem(string id)
    {
        var cookId = await EnsureCookIdAsync();
        if (string.IsNullOrEmpty(cookId)) return;

        await InventoryService.DeleteAsync(cookId, id);
        await ReloadAsync();
    }

    private async Task ChangeQuantity(InventoryItem item, decimal delta)
    {
        var cookId = await EnsureCookIdAsync();
        if (item.Id is null || string.IsNullOrEmpty(cookId)) return;

        await InventoryService.UpdateQuantityAsync(cookId, item.Id, delta);
        await ReloadAsync();
    }

    private string GetStatus(InventoryItem item)
    {
        if (item.LowStockThreshold.HasValue && item.Quantity <= item.LowStockThreshold.Value)
        {
            return "Low";
        }

        return "OK";
    }
}
